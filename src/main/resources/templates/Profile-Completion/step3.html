<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Profile Completion</title>
    <link href="/static/css/basic-template.css" rel="stylesheet" th:href="@{/css/basic-template.css}">
    <link rel="stylesheet" href="/static/css/Profile-Completion/step3.css" th:href="@{/css/Profile-Completion/step3.css}">
    <!--Jquery-Imports-------------->
    <link href="/static/css/jquery/jquery-ui.theme.min.css" rel="stylesheet" th:href="@{/css/jquery/jquery-ui.theme.min.css}">
    <link href="/static/css/jquery/jquery-ui.structure.min.css" rel="stylesheet" th:href="@{/css/jquery/jquery-ui.structure.min.css}">
    <link href="/static/css/jquery/jquery-ui.min.css" rel="stylesheet" th:href="@{/css/jquery/jquery-ui.min.css}">
    <script src="/static/js/jquery-3.3.1.min.js" th:src="@{/js/jquery-3.3.1.min.js}"></script>
    <!--<script src="/static/js/jquery.iframe-transport.js" th:src="@{/js/jquery.iframe-transport.js}"></script>-->
    <script src="/static/js/jquery.ui.widget.js" th:src="@{/js/jquery.ui.widget.js}"></script>
    <script src="/static/js/jquery-ui.min.js" th:src="@{/js/jquery-ui.min.js}"></script>
    <link rel="manifest" href="/static/icons/manifest.json" th:href="@{/static/icons/manifest.json}">   
    <!------------------------------->
</head>
<body>

<p id="heading">
    We need a few more details.
</p>
<div class="progress-bar" id="progress-bar">
    <div class="progress-bar-status" id="progress-bar-1">1</div>
    <div class="progress-bar-status" id="progress-bar-2"></div>
    <div class="progress-bar-status" id="progress-bar-3">2</div>
    <div class="progress-bar-status" id="progress-bar-4"></div>
    <div class="progress-bar-status" id="progress-bar-5">3</div>
</div>
<main>
    <form action="" id="pincode" method="POST" name="pincode" th:action="@{/profileCompletion}" th:object="${user}">
        <div class="ui-widget" id="1pincode">
            <label for="search-pincode" id="title">Your preffered pick-up locations:</label>
        </div>
        <input class="ui-autocomplete-input" id="search-pincode" name="search-pincode" placeholder="Search Pincode" type="search">
        <div class="selected-pincodes" id="selected-pincodes">
            <p>Selected Pincodes:</p>
            <div id = "selected-pin-content">
                <ul id="selected-pincode-ul"></ul>
            </div>
        </div>
        <button form="pincode" id="next" type="submit">Submit</button>
        <input name="page" type="hidden" value="3">
    </form>
</main>

<script>
    $(document).ready(function () {
        let counter = 1;
        $("#search-pincode").autocomplete({
            //appendTo  : "#search-pincode-results",
            minLength: 2,
            delay: 500,
            //define callback to format results
            source: function (request, response) {
                var pinCodeIds = $('input[name="pincodeId"]').map(function() { return $(this).val();}).get();
                console.info(pinCodeIds);
                console.info(request.term);
                console.info(JSON.stringify(request));
                var pins ="";
                for(i in pinCodeIds) {
                    pins = pins+pinCodeIds[i]+",";
                }
                if(pins) {
                    pins = pins.substr(0,pins.length-1);
                }
                request.selectedPinCodes = pins;
                console.info(JSON.stringify(request));
                $.getJSON("/getPinCodeLandMark", request, function (result) {
                    response($.map(result, function (item) {
                        return {
                            // following property gets displayed in drop down
                            label: item.landmark + " - " + item.pincode,
                            // following property gets entered in the textbox
                            value: item.pincodeId,
                            // following property is added for our own use
                            landmarks: item.landmark,
                            pincode: item.pincode
                        }

                    }));
                });
            },

            //define select handler
            select: function (event, ui) {
                var iCnt = 0;
                document.getElementById("selected-pincodes").style.display = "block";
                if (ui.item) {
                        //----CREATING-ELEMENTS-AND-ADD-ATTRIBUTES----------------------------------------------------
                        var li = document.createElement("li");
                        li.classList.add("li-member" + counter);
                        var div = document.createElement("div");
                        var inner_div = document.createElement("div");
                        var inner_div2 = document.createElement("div");
                        var landmarks = ui.item.landmarks;
                        var pincodes = ui.item.pincode;
                        var span = document.createElement("span");
                        span.classList.add("remove-pincode");
                        span.setAttribute("onclick","remove_pincode(this.parentElement.parentElement.parentElement.classList)");
                        var input = document.createElement("input");
                        input.setAttribute("type", "checkbox");
                        input.setAttribute("name","pincode-timing-check");
                        input.setAttribute("id","pincode-timing-check" + counter);
                        input.classList.add("pincode-timing-check");
                        input.classList.add("member" + counter);
                        input.setAttribute("onclick", "select_timings_dropdown(this)");
                        var label = document.createElement("label");
                        label.setAttribute("for", "pincode-timing-check" + counter);
                        label.innerHTML = "Specify Timings";
                        var input_select = document.createElement("select");
                        input_select.setAttribute("name", "selectedTiming");
                        input_select.setAttribute("id", "select-timings");
                        input_select.classList.add("select-timings");
                        input_select.classList.add("member" + counter);
                        var option1 = document.createElement("option");
                        option1.innerHTML = "00 - 04";
                        var option2 = document.createElement("option");
                        option2.innerHTML = "04 - 08";
                        var option3 = document.createElement("option");
                        option3.innerHTML = "08 - 12";
                        var option4 = document.createElement("option");
                        option4.innerHTML = "12 - 16";
                        var option5 = document.createElement("option");
                        option5.innerHTML = "16 - 20";
                        var option6 = document.createElement("option");
                        option6.innerHTML = "20 - 24";

                        var hidden_input = document.createElement("input");
                        hidden_input.setAttribute("type", "hidden");
                        hidden_input.setAttribute("name", "pincodeId");
                        hidden_input.setAttribute("value",ui.item.value);

                        //-----APPEND-CHILDNODES-----------------------------------------------------------------------
                        span.innerHTML = "&times;";
                        inner_div.innerHTML += landmarks + " - " + pincodes;
                        inner_div.appendChild(span);
                        inner_div.appendChild(hidden_input);
                        inner_div2.appendChild(input);
                        inner_div2.appendChild(label);
                        input_select.appendChild(option1);
                        input_select.appendChild(option2);
                        input_select.appendChild(option3);
                        input_select.appendChild(option4);
                        input_select.appendChild(option5);
                        input_select.appendChild(option6);
                        inner_div2.appendChild(input_select);
                        div.appendChild(inner_div);
                        div.appendChild(inner_div2);
                        li.appendChild(div);
                        document.getElementById("selected-pincode-ul").append(li);
                        counter++;
                    //-------------------------------------------------------------------------------------------------
                    $("#search-pincode").autocomplete("close");
                    $("#search-pincode").val('');
                    return false;
                }
            }
        });
    });

    function select_timings_dropdown(this_t){
        console.log(this_t);
        let y = [this_t.className.split(' ')];
        let member_number = y[0][1];
        if(event.target.checked){
            document.getElementsByClassName(member_number)[1].style.display = "inline-block";
        }
        else {
            document.getElementsByClassName(member_number)[1].style.display = "none";
        }
    }

    function remove_pincode(class_Name){
        document.getElementsByClassName(class_Name)[0].remove();
        if (document.getElementById("selected-pincode-ul").childNodes.length < 1){
            document.getElementById("selected-pincodes").style.display = "none";
        }
    }
</script>
    
</body>
</html>